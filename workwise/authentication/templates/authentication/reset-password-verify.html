{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/vendors.css' %}">
    <link media="all" rel="stylesheet" href="{% static 'css/jobplugin.css' %}">
    <link media="all" rel="stylesheet" href="{% static 'css/theme-color.css' %}">
  <title>Verify & Reset Password</title>
  <style>
    .jobplugin__userbox input {
      width:100%; margin:10px 0; padding:10px;
      border:1px solid #ddd; border-radius:6px;
    }
  </style>
</head>
<body class="jobplugin">
  <div class="jobplugin__wrapper">
    {% include "includes/header.html" %}
    <main class="jobplugin__main">
      <div class="jobplugin__container">
        <div class="jobplugin__userbox">
          <span class="jobplugin__userbox-bar jobplugin__bg-primary"></span>
          <h2 class="jobplugin__text-secondary h3">Verify & Reset</h2>
            <p>We’ve sent a 6-digit code to <strong id="display-email">{{ form_data.email }}</strong></p>
          <form id="verify-form" method="post" action="{% url 'auth:reset_password_verify' %}">
            {% csrf_token %}

            {% if otp_error %}
              <p id="otpError" style="color:red; font-size:small; margin-bottom:10px;">
                {{ otp_error }}
              </p>
            {% endif %}

            <p id="clientError" style="color:red; font-size:small; margin-bottom:10px;"></p>

            <input type="password" name="new_password" placeholder="New Password (6–16 chars)">
            <input type="password" name="confirm_password" placeholder="Confirm Password">
            <input type="text"  name="verification_code" placeholder="6-digit Code" maxlength="6">

            <div class="jobplugin__userbox-button">
              <button type="submit" name="verify_otp" id="verifyBtn"
                      class="jobplugin__button jobplugin__bg-primary" disabled
                      style="opacity:0.5;">
                Verify & Reset
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
    {% include "includes/footer.html" %}
  </div>

  <!-- jQuery Library -->
<script src="{% static 'js/jquery-3.6.4.min.js' %}"></script>
<!-- jQuery Plugins File -->
<script src="{% static 'js/vendor.js' %}"></script>
<!-- jQuery Functions JS File -->
<script src="{% static 'js/jquery.main.js' %}"></script>

<script>
(function(){
  const newPwd    = document.querySelector("input[name='new_password']");
  const confirmEl = document.querySelector("input[name='confirm_password']");
  const otp       = document.querySelector("input[name='verification_code']");
  const errorEl   = document.getElementById("clientError");
  const submitBtn = document.getElementById("verifyBtn");

  // Regex: 6–16 chars, at least one digit & special char
  const pwdRe = /^(?=.*\d)(?=.*[!@#$%^&*]).{6,16}$/;
  // Regex: exactly 6 digits
  const otpRe = /^\d{6}$/;

  // Track whether the user has left each field
  const touched = {
    new_password: false,
    confirm_password: false,
    verification_code: false
  };

  function validate() {
    let msg = "";

    if (touched.new_password && !pwdRe.test(newPwd.value)) {
      msg = "password must be 6–16 chars, include a number & special character";
    } else if (touched.confirm_password && newPwd.value !== confirmEl.value) {
      msg = "passwords do not match";
    } else if (touched.verification_code && !otpRe.test(otp.value.trim())) {
      msg = "enter a valid 6-digit code";
    }

    errorEl.textContent = msg;

    const allValid = 
      pwdRe.test(newPwd.value) &&
      newPwd.value === confirmEl.value &&
      otpRe.test(otp.value.trim());

    submitBtn.disabled = !allValid;
    submitBtn.style.opacity = allValid ? "1" : "0.5";
  }

  // Mark touched on blur, then run validate on blur & input
  newPwd.addEventListener("blur",    () => { touched.new_password = true; validate(); });
  newPwd.addEventListener("input",   () => { if (touched.new_password) validate(); });

  confirmEl.addEventListener("blur",    () => { touched.confirm_password = true; validate(); });
  confirmEl.addEventListener("input",   () => { if (touched.confirm_password) validate(); });

  otp.addEventListener("blur",    () => { touched.verification_code = true; validate(); });
  otp.addEventListener("input",   () => { if (touched.verification_code) validate(); });

  // Initial call to set button state
  validate();
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const backendErr = document.getElementById("otpError");
  if (backendErr) {
    setTimeout(() => {
      backendErr.style.display = "none";
    }, 10000);
  }
});
</script>



</body>
</html>
